<h1 class="text-3xl font-bold mb-2 mt-6">Productos</h1>

<div class="grid grid-cols-1 lg:grid-cols-[18%_1fr] gap-4 lg:gap-6 items-start">
  <aside class="hidden lg:block rounded-xl border border-base-200 bg-base-100/60 p-3 shadow-sm backdrop-blur-sm">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold text-base-content">Categor√≠as</h3>
    </div>

    <ul class="flex flex-col gap-2 max-h-[60vh] overflow-auto pr-1">
      <li>
        <button
          class="w-full text-left p-2 rounded-md cursor-pointer text-base-content transition-colors duration-200 hover:bg-base-200 hover:text-base-content"
          [class.bg-base-200]="pendingCategory() === 'all'"
          [class.font-semibold]="pendingCategory() === 'all'"
          type="button"
          (click)="selectCategory('all')"
        >
          Todos
        </button>
      </li>
      @for (cat of categories(); track cat.id) {
        <li>
          <button
            class="w-full text-left p-2 rounded-md cursor-pointer text-base-content transition-colors duration-200 hover:bg-base-200 hover:text-base-content"
            [class.bg-base-200]="pendingCategory() === cat.id"
            [class.font-semibold]="pendingCategory() === cat.id"
            type="button"
            (click)="selectCategory(cat.id)"
          >
            {{ cat.name }}
          </button>
        </li>
      }
    </ul>

    <div class="mt-6 space-y-2">
      <div class="flex items-center justify-between">
        <h4 class="font-semibold text-base-content">Tags</h4>
        <button
          class="text-primary text-xs cursor-pointer"
          type="button"
          [disabled]="!selectedTags().size && !pendingTags().size"
          [class.opacity-50]="!selectedTags().size && !pendingTags().size"
          (click)="resetTags()"
        >
          Limpiar
        </button>
      </div>
      <div class="flex flex-wrap gap-2">
        @for (tag of tags(); track tag.id) {
          <button
            type="button"
            class="filter-tag btn btn-sm rounded-md min-h-9 px-4"
            [ngClass]="pendingTags().has(tag.id) ? 'btn-outline border-base-200 bg-base-200 text-base-content font-semibold' : 'btn-outline border-base-200 text-base-content'"
            (click)="toggleTag(tag.id)"
          >
            {{ tag.name }}
          </button>
        }
      </div>
      <div class="flex gap-2">
        <button
          type="button"
          class="btn btn-sm flex-1"
          [disabled]="!hasPendingChanges()"
          (click)="applyFilters()"
        >
          Aplicar
        </button>
      </div>
    </div>
  </aside>

  <section class="flex flex-col gap-4">
    <div class="flex flex-wrap gap-3 items-center justify-between">
      <span class="inline-flex items-center gap-2">
        Total de productos
        <span class="font-bold">
          {{ productResponse()?.count === null ? 0 : productResponse()?.count }}
        </span>
      </span>

      <div class="flex flex-wrap items-center justify-end gap-3">
        <div class="flex items-center gap-2">
          <label class="opacity-70">Ordenar</label>
          <select
            class="select select-bordered select-sm w-40 focus-within:outline-none cursor-pointer"
            (change)="onSortChange(sortSelect.value)"
            #sortSelect
          >
            <option [selected]="sortOption() === 'relevance'" value="relevance">Relevancia</option>
            <option [selected]="sortOption() === 'price-asc'" value="price-asc">Precio: menor a mayor</option>
            <option [selected]="sortOption() === 'price-desc'" value="price-desc">Precio: mayor a menor</option>
            <option [selected]="sortOption() === 'title-asc'" value="title-asc">Nombre A-Z</option>
            <option [selected]="sortOption() === 'title-desc'" value="title-desc">Nombre Z-A</option>
            <option [selected]="sortOption() === 'featured'" value="featured">Destacados</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <label class="opacity-70">Mostrar</label>
          <span class="inline-flex items-center gap-2">
            <select
              class="select select-bordered select-sm w-16 focus-within:outline-none cursor-pointer"
              (change)="updateProductsPerPage(+selectPerPage.value)"
              #selectPerPage
            >
              <option [selected]="productPerPage() === 8" value="8">8</option>
              <option [selected]="productPerPage() === 20" value="20">20</option>
              <option [selected]="productPerPage() === 50" value="50">50</option>
              <option [selected]="productPerPage() === 100" value="100">100</option>
            </select>
          </span>
        </div>
      </div>
    </div>

    @if (loading()) {
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 mt-6 gap-4 sm:gap-6 md:gap-8">
        @for (placeholder of [1, 2, 3, 4, 5, 6, 7, 8]; track placeholder) {
          <article class="skeletor-card p-3 space-y-3">
            <div class="h-40 rounded-2xl bg-base-200/40"></div>
            <div class="skeletor-line"></div>
            <div class="skeletor-line w-2/3"></div>
            <div class="flex items-center justify-between">
              <div class="skeletor-line w-1/3"></div>
              <div class="skeletor-pill w-16"></div>
            </div>
          </article>
        }
      </div>
    }

    @if (error()) {
      <p class="text-red-500">{{ error() }}</p>
    }

    @if (!loading() && !error() && productResponse()?.products?.length) {
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 mt-6 gap-4 sm:gap-6 md:gap-8">
        @for (product of viewProducts(); track product.__viewKey) {
          <product-card [product]="product" />
        }
      </div>

      <div class="flex justify-center mt-10">
        <pagination
          [pages]="productResponse()?.pages ?? 0"
          [currentPage]="paginationService.currentPage()"
        ></pagination>
      </div>
    }

    @if (!loading() && !error() && productResponse()?.products?.length === 0) {
      <p>No se encontraron productos</p>
    }
  </section>
</div>
